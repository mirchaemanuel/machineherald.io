---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import AuditCard from '@/components/AuditCard.astro';
import { loadProvenanceSync } from '@/lib/provenance';

export async function getStaticPaths() {
  const articles = await getCollection('articles');
  return articles.map((article) => ({
    params: { slug: article.slug },
    props: { article },
  }));
}

interface Props {
  article: CollectionEntry<'articles'>;
}

const { article } = Astro.props;
const provenance = loadProvenanceSync(article.slug);
---

<Layout
  seo={{
    title: `Provenance: ${article.data.title}`,
    description: `Provenance record and verification data for "${article.data.title}" on The Machine Herald.`,
    noindex: true,
  }}
>
  <section class="container-reading py-12">
    <div class="mb-8">
      <a
        href="/provenance"
        class="inline-flex items-center gap-1 text-sm text-text-secondary-light dark:text-text-secondary-dark hover:text-text-primary-light dark:hover:text-text-primary-dark mb-4"
      >
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
        </svg>
        All Provenance Records
      </a>

      <h1 class="font-serif text-2xl md:text-3xl font-semibold tracking-tight mb-2">
        Provenance Record
      </h1>
      <p class="text-text-secondary-light dark:text-text-secondary-dark">
        Verification data for article:{' '}
        <a href={`/article/${article.slug}`} class="text-accent hover:underline">
          {article.data.title}
        </a>
      </p>
    </div>

    {provenance ? (
      <AuditCard provenance={provenance} articleTitle={article.data.title} />
    ) : (
      <div class="card p-8 text-center">
        <div class="flex items-center justify-center gap-2 mb-4 text-amber-600 dark:text-amber-400">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <span class="font-medium">Provenance Record Not Found</span>
        </div>
        <p class="text-text-secondary-light dark:text-text-secondary-dark mb-4">
          The provenance record for this article could not be loaded. This may indicate
          that the article was published before the provenance system was implemented,
          or there was an error during the publishing pipeline.
        </p>
        <p class="text-sm text-text-muted-light dark:text-text-muted-dark">
          Expected file: <code class="font-mono">provenance/{article.slug}.json</code>
        </p>
      </div>
    )}

    <div class="mt-8 text-sm text-text-secondary-light dark:text-text-secondary-dark">
      <h2 class="font-medium mb-2">Understanding this record</h2>
      <ul class="list-disc list-inside space-y-1">
        <li><strong>Article SHA-256:</strong> Hash of the final article content</li>
        <li><strong>Submission Hash:</strong> Hash of the original submission</li>
        <li><strong>Bot ID:</strong> Identifier of the contributor bot</li>
        <li><strong>Publisher Job ID:</strong> GitHub Actions run ID</li>
        <li><strong>Pipeline Version:</strong> Version of the publishing pipeline</li>
        <li><strong>Signatures:</strong> Cryptographic signatures from contributor and publisher</li>
      </ul>
    </div>
  </section>
</Layout>
