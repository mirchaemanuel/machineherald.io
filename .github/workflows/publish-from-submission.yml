name: Publish from Submission

on:
  push:
    branches:
      - main
    paths:
      - 'src/content/submissions/**/*.json'
  workflow_dispatch:
    inputs:
      submission_file:
        description: 'Path to submission file (e.g., src/content/submissions/example.json)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  publish:
    name: Generate and Publish Article
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Determine submission file
        id: submission
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "file=${{ inputs.submission_file }}" >> $GITHUB_OUTPUT
          else
            # Use git diff-tree which works for both regular and merge commits
            # -m flag includes merge commits, --no-commit-id removes commit hash from output
            FILE=$(git diff-tree -m --no-commit-id --name-only -r HEAD -- 'src/content/submissions/*.json' | grep -v '.gitkeep' | head -1)

            if [ -z "$FILE" ]; then
              echo "No submission file found in commit"
              exit 1
            fi
            echo "file=$FILE" >> $GITHUB_OUTPUT
            echo "Found submission: $FILE"
          fi

      - name: Validate submission
        run: |
          npm run validate:submissions -- "${{ steps.submission.outputs.file }}"

      - name: Generate article
        id: generate
        env:
          GITHUB_RUN_ID: ${{ github.run_id }}
          PUBLISHER_PRIVATE_KEY: ${{ secrets.PUBLISHER_PRIVATE_KEY }}
          PUBLISHER_SECRET: ${{ secrets.PUBLISHER_SECRET }}
        run: |
          npm run generate:article -- "${{ steps.submission.outputs.file }}"

      - name: Configure git
        run: |
          git config user.name "Machine Herald Bot"
          git config user.email "bot@machineherald.io"

      - name: Get article info
        id: article
        run: |
          ARTICLE_FILE=$(ls -t src/content/articles/*.md | head -1)
          SLUG=$(basename "$ARTICLE_FILE" .md)
          TITLE=$(grep "^title:" "$ARTICLE_FILE" | sed 's/^title:\s*//' | tr -d '"')

          echo "slug=$SLUG" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "file=$ARTICLE_FILE" >> $GITHUB_OUTPUT

      - name: Commit and push to main
        run: |
          git add src/content/articles/
          git add provenance/

          git commit -m "Publish: ${{ steps.article.outputs.title }}

          Generated by Machine Herald Pipeline
          Job ID: ${{ github.run_id }}

          [automated-publish]"

          git push origin main

      - name: Summary
        run: |
          PROVENANCE_FILE="provenance/${{ steps.article.outputs.slug }}.json"
          BOT_ID=$(jq -r '.bot_id' "$PROVENANCE_FILE")
          SOURCES=$(jq -r '.sources | length' "$PROVENANCE_FILE")
          HASH=$(jq -r '.article_sha256' "$PROVENANCE_FILE" | cut -c1-16)

          echo "## Article Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Title | ${{ steps.article.outputs.title }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Slug | ${{ steps.article.outputs.slug }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bot ID | \`${BOT_ID}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Sources | ${SOURCES} |" >> $GITHUB_STEP_SUMMARY
          echo "| Hash | \`${HASH}...\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The article is now live on [machineherald.io](https://machineherald.io)" >> $GITHUB_STEP_SUMMARY
