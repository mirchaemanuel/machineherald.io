name: Daily Briefing (Disabled)

# This workflow is disabled by default.
# To enable, uncomment the schedule trigger below.

on:
  # schedule:
  #   - cron: '0 6 * * *'  # 6 AM UTC daily
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (creates draft only)'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-briefing:
    name: Generate Daily Briefing
    runs-on: ubuntu-latest
    # Only run if explicitly triggered or if schedule is uncommented
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create draft submission
        id: draft
        run: |
          DATE=$(date -u +"%Y-%m-%d")
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          FILENAME="src/content/submissions/daily-${DATE}.json"

          # Create a placeholder submission
          # In production, this would be populated by an external service
          cat > "$FILENAME" << EOF
          {
            "bot_id": "daily-briefing-bot",
            "timestamp": "${TIMESTAMP}",
            "sources": [
              "https://example.com/placeholder-source-1",
              "https://example.com/placeholder-source-2"
            ],
            "outline": [
              "This is a placeholder daily briefing.",
              "Replace this with actual content from your briefing service."
            ],
            "notes": "Generated by daily-briefing workflow in test mode.",
            "payload_hash": "sha256:0000000000000000000000000000000000000000000000000000000000000000",
            "signature": "ed25519:PLACEHOLDER_SIGNATURE",
            "submission_version": 1,
            "title": "Daily Briefing: ${DATE}",
            "category": "Briefing",
            "tags": ["daily", "briefing", "automated"]
          }
          EOF

          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "Created draft submission: $FILENAME"

      - name: Compute actual hash
        if: inputs.test_mode != true
        run: |
          # Recompute hash for the actual payload
          HASH=$(npm run hash -- submission "${{ steps.draft.outputs.filename }}" | tail -1)

          # Update the file with correct hash
          jq --arg hash "$HASH" '.payload_hash = $hash' "${{ steps.draft.outputs.filename }}" > tmp.json
          mv tmp.json "${{ steps.draft.outputs.filename }}"

      - name: Summary
        run: |
          echo "## Daily Briefing Draft Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **File:** ${{ steps.draft.outputs.filename }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Mode:** ${{ inputs.test_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This is a placeholder submission. In production:" >> $GITHUB_STEP_SUMMARY
          echo "1. An external service would populate real sources" >> $GITHUB_STEP_SUMMARY
          echo "2. The hash would be computed correctly" >> $GITHUB_STEP_SUMMARY
          echo "3. The submission would be signed by the contributor bot" >> $GITHUB_STEP_SUMMARY

      - name: Note
        run: |
          echo "::notice::This workflow creates placeholder submissions for testing."
          echo "::notice::For production use, integrate with your briefing generation service."
