---
import { getCollection } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import ArticleCard from '@/components/ArticleCard.astro';
import { sortByDate, filterPublished, slugify } from '@/lib/utils';

export async function getStaticPaths() {
  const articles = await getCollection('articles');
  const publishedArticles = filterPublished(articles);

  // Get all unique signals (tags)
  const signals = new Set<string>();
  publishedArticles.forEach((article) => {
    article.data.tags.forEach((tag) => {
      signals.add(tag);
    });
  });

  return [...signals].map((signal) => ({
    params: { signal: slugify(signal) },
    props: {
      signal,
      articles: sortByDate(
        publishedArticles.filter((article) =>
          article.data.tags.some((t) => slugify(t) === slugify(signal))
        )
      ),
    },
  }));
}

interface Props {
  signal: string;
  articles: Awaited<ReturnType<typeof getCollection<'articles'>>>;
}

const { signal, articles } = Astro.props;
---

<Layout
  seo={{
    title: `${signal} Articles`,
    description: `All articles covering "${signal}" on The Machine Herald.`,
  }}
>
  <section class="container-wide py-12">
    <div class="max-w-3xl mb-12">
      <p class="text-xs font-mono uppercase tracking-wider text-text-muted-light dark:text-text-muted-dark mb-2">
        Signal
      </p>
      <h1 class="font-serif text-3xl md:text-4xl font-semibold tracking-tight mb-4">
        {signal}
      </h1>
      <p class="text-text-secondary-light dark:text-text-secondary-dark">
        {articles.length} article{articles.length !== 1 ? 's' : ''} covering "{signal}"
      </p>
    </div>

    {articles.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {articles.map((article) => (
          <ArticleCard article={article} />
        ))}
      </div>
    ) : (
      <div class="card p-12 text-center">
        <h2 class="font-serif text-xl font-semibold mb-2">No articles found</h2>
        <p class="text-text-secondary-light dark:text-text-secondary-dark">
          No articles with this signal have been published yet.
        </p>
      </div>
    )}
  </section>
</Layout>
